


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > BlueskyPlatform</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">de.busesteinkamp.plugins.platform</a>
</div>

<h1>Coverage Summary for Class: BlueskyPlatform (de.busesteinkamp.plugins.platform)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BlueskyPlatform</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/127)
  </span>
</td>
</tr>
  <tr>
    <td class="name">BlueskyPlatform$authorize$1</td>
  </tr>
  <tr>
    <td class="name">BlueskyPlatform$createPostWithImages$1</td>
  </tr>
  <tr>
    <td class="name">BlueskyPlatform$handleImagePost$1</td>
  </tr>
  <tr>
    <td class="name">BlueskyPlatform$handleTextPost$1</td>
  </tr>
  <tr>
    <td class="name">BlueskyPlatform$parseFacets$1</td>
  </tr>
  <tr>
    <td class="name">BlueskyPlatform$upload$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BlueskyPlatform$upload$1$WhenMappings</td>
  </tr>
  <tr>
    <td class="name">BlueskyPlatform$uploadImage$1</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/135)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package de.busesteinkamp.plugins.platform
&nbsp;
&nbsp;import de.busesteinkamp.adapters.content.ImageContent
&nbsp;import de.busesteinkamp.adapters.content.TextContent
&nbsp;import de.busesteinkamp.domain.auth.EnvRetriever
&nbsp;import de.busesteinkamp.domain.content.Content
&nbsp;import de.busesteinkamp.domain.content.ContentType
&nbsp;import de.busesteinkamp.domain.platform.PublishParameters
&nbsp;import de.busesteinkamp.domain.platform.SocialMediaPlatform
&nbsp;import de.busesteinkamp.domain.process.UploadStatus
&nbsp;import de.busesteinkamp.plugins.data.*
&nbsp;import io.ktor.client.*
&nbsp;import io.ktor.client.call.*
&nbsp;import io.ktor.client.engine.cio.*
&nbsp;import io.ktor.client.plugins.contentnegotiation.*
&nbsp;import io.ktor.client.request.*
&nbsp;import io.ktor.client.statement.*
&nbsp;import io.ktor.http.*
&nbsp;import io.ktor.http.content.*
&nbsp;import io.ktor.serialization.kotlinx.json.*
&nbsp;import kotlinx.coroutines.CoroutineScope
&nbsp;import kotlinx.coroutines.Dispatchers
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.json.Json
&nbsp;import java.util.*
&nbsp;
<b class="nc">&nbsp;class BlueskyPlatform(id: UUID?, name: String, private val envRetriever: EnvRetriever) : SocialMediaPlatform(id, name) {</b>
&nbsp;
<b class="nc">&nbsp;    private val client: HttpClient = HttpClient(CIO) {</b>
<b class="nc">&nbsp;        install(ContentNegotiation) {</b>
<b class="nc">&nbsp;            json(Json {</b>
<b class="nc">&nbsp;                ignoreUnknownKeys = true</b>
<b class="nc">&nbsp;                isLenient = true</b>
&nbsp;            })
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private val username: String
&nbsp;    private val password: String
&nbsp;
<b class="nc">&nbsp;    private var authToken: String = &quot;&quot;</b>
&nbsp;
<b class="nc">&nbsp;    init {</b>
<b class="nc">&nbsp;        username = envRetriever.getEnvVariable(&quot;BSKY_USERNAME&quot;)</b>
<b class="nc">&nbsp;        password = envRetriever.getEnvVariable(&quot;BSKY_PASSWORD&quot;)</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    override fun upload(content: Content, publishParameters: PublishParameters, callback: ((UploadStatus) -&gt; Unit)?) {
<b class="nc">&nbsp;        if (username == &quot;&quot; || password == &quot;&quot;) {</b>
<b class="nc">&nbsp;            throw IllegalStateException(&quot;Bluesky credentials not set&quot;)</b>
&nbsp;        }
<b class="nc">&nbsp;        CoroutineScope(Dispatchers.IO).launch {</b>
<b class="nc">&nbsp;            authorize()</b>
<b class="nc">&nbsp;            callback?.invoke(UploadStatus.PENDING)</b>
<b class="nc">&nbsp;            when (content.contentType) {</b>
<b class="nc">&nbsp;                ContentType.TEXT_PLAIN -&gt; handleTextPost(content)</b>
<b class="nc">&nbsp;                ContentType.IMAGE_JPEG -&gt; handleImagePost(content, publishParameters)</b>
<b class="nc">&nbsp;                ContentType.IMAGE_PNG -&gt; handleImagePost(content, publishParameters)</b>
&nbsp;                //ContentType.IMAGE_MULTIPLE -&gt; handleMultipleImagePost(content, publishParameters)
<b class="nc">&nbsp;                else -&gt; throw IllegalArgumentException(&quot;Unsupported filetype&quot;)</b>
&nbsp;            }
<b class="nc">&nbsp;            callback?.invoke(UploadStatus.FINISHED)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun authorize() {
<b class="nc">&nbsp;        val response: BlueskyAuthResponse = client.post(&quot;https://bsky.social/xrpc/com.atproto.server.createSession&quot;) {</b>
<b class="nc">&nbsp;            contentType(io.ktor.http.ContentType.Application.Json)</b>
<b class="nc">&nbsp;            setBody(BlueskyAuthRequest(username, password))</b>
<b class="nc">&nbsp;        }.body()</b>
&nbsp;
<b class="nc">&nbsp;        authToken = response.accessJwt</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun handleTextPost(content: Content) {
<b class="nc">&nbsp;        println(&quot;Uploading text file to Bluesky&quot;)</b>
<b class="nc">&nbsp;        val text = content as TextContent</b>
&nbsp;
<b class="nc">&nbsp;        val postRequest = BlueskyCreatePostRequest(</b>
<b class="nc">&nbsp;            collection = &quot;app.bsky.feed.post&quot;,</b>
<b class="nc">&nbsp;            repo = username,</b>
<b class="nc">&nbsp;            record = BlueskyPostRecord(text.get(), convertDateToIso8601(Date()), facets = parseFacets(text.get())),</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        val response = client.post(&quot;https://bsky.social/xrpc/com.atproto.repo.createRecord&quot;) {</b>
<b class="nc">&nbsp;            contentType(io.ktor.http.ContentType.Application.Json)</b>
<b class="nc">&nbsp;            bearerAuth(authToken)</b>
<b class="nc">&nbsp;            setBody(postRequest)</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (response.status != HttpStatusCode.OK) {</b>
<b class="nc">&nbsp;            throw IllegalStateException(&quot;Error uploading text file to Bluesky. Server responded with status ${response.status}: ${response.bodyAsText()}&quot;)</b>
&nbsp;        }
<b class="nc">&nbsp;        println(&quot;Text file uploaded to Bluesky&quot;)</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun handleImagePost(content: Content, publishParameters: PublishParameters) {
<b class="nc">&nbsp;        val blobRef = uploadImage(content)</b>
<b class="nc">&nbsp;        val blobRefs = listOf(</b>
<b class="nc">&nbsp;            BlueskyBlobImage(</b>
<b class="nc">&nbsp;                alt = (content as ImageContent).altText,</b>
<b class="nc">&nbsp;                image = blobRef.blob</b>
&nbsp;            )
&nbsp;        )
<b class="nc">&nbsp;        createPostWithImages(blobRefs, publishParameters)</b>
&nbsp;    }
&nbsp;
&nbsp;//    private suspend fun handleMultipleImagePost(mediaFile: MediaFile, publishParameters: PublishParameters){
&nbsp;//        val multipleImageFile = mediaFile as MultipleImageFiles
&nbsp;//
&nbsp;//        if(multipleImageFile.imageFiles.isEmpty()){
&nbsp;//            throw IllegalArgumentException(&quot;No image files provided&quot;)
&nbsp;//        }
&nbsp;//
&nbsp;//        if(multipleImageFile.imageFiles.size &gt; 4){
&nbsp;//            throw IllegalArgumentException(&quot;Maximum of 4 images allowed&quot;)
&nbsp;//        }
&nbsp;//
&nbsp;//        val blobs = mutableListOf&lt;BlueskyBlobImage&gt;()
&nbsp;//        multipleImageFile.imageFiles.forEach({
&nbsp;//            val blob = uploadImage(it).blob
&nbsp;//            blobs.add(
&nbsp;//                BlueskyBlobImage(
&nbsp;//                    alt = it.altText,
&nbsp;//                    image = blob
&nbsp;//                )
&nbsp;//            )
&nbsp;//        })
&nbsp;//
&nbsp;//        createPostWithImages(blobs, publishParameters)
&nbsp;//     }
&nbsp;
&nbsp;    private suspend fun uploadImage(content: Content): BlueskyUploadResponse {
<b class="nc">&nbsp;        println(&quot;Uploading image file to Bluesky&quot;)</b>
<b class="nc">&nbsp;        val imageFile = content as ImageContent</b>
&nbsp;
<b class="nc">&nbsp;        if (imageFile.size &gt; 1000000) {</b>
<b class="nc">&nbsp;            throw IllegalArgumentException(&quot;Image file too large. Maximum size is 1MB&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val response = client.post(&quot;https://bsky.social/xrpc/com.atproto.repo.uploadBlob&quot;) {</b>
<b class="nc">&nbsp;            bearerAuth(authToken)</b>
<b class="nc">&nbsp;            setBody(</b>
<b class="nc">&nbsp;                ByteArrayContent(</b>
<b class="nc">&nbsp;                    imageFile.get(),</b>
<b class="nc">&nbsp;                    contentType = io.ktor.http.ContentType.parse(imageFile.contentType.mimeType)</b>
&nbsp;                )
&nbsp;            )
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (response.status != HttpStatusCode.OK) {</b>
<b class="nc">&nbsp;            throw IllegalStateException(&quot;Error uploading image file to Bluesky. Server responded with status ${response.status}: ${response.bodyAsText()}&quot;)</b>
&nbsp;        }
<b class="nc">&nbsp;        println(&quot;Image file uploaded to Bluesky&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        return response.body()</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun createPostWithImages(blobs: List&lt;BlueskyBlobImage&gt;, publishParameters: PublishParameters) {
<b class="nc">&nbsp;        val postRequest = BlueskyCreatePostRequest(</b>
<b class="nc">&nbsp;            repo = username,</b>
<b class="nc">&nbsp;            record = BlueskyPostRecord(</b>
<b class="nc">&nbsp;                `$type` = &quot;app.bsky.feed.post&quot;,</b>
<b class="nc">&nbsp;                text = publishParameters.title,</b>
<b class="nc">&nbsp;                createdAt = convertDateToIso8601(Date()),</b>
<b class="nc">&nbsp;                embed = BlueskyPostEmbedImages(</b>
<b class="nc">&nbsp;                    images = blobs,</b>
<b class="nc">&nbsp;                    `$type` = &quot;app.bsky.embed.images&quot;</b>
&nbsp;                ),
<b class="nc">&nbsp;                facets = parseFacets(publishParameters.title)</b>
&nbsp;            ),
<b class="nc">&nbsp;            collection = &quot;app.bsky.feed.post&quot;</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        val response = client.post(&quot;https://bsky.social/xrpc/com.atproto.repo.createRecord&quot;) {</b>
<b class="nc">&nbsp;            bearerAuth(authToken)</b>
<b class="nc">&nbsp;            contentType(io.ktor.http.ContentType.Application.Json)</b>
<b class="nc">&nbsp;            setBody(postRequest)</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (response.status != HttpStatusCode.OK) {</b>
<b class="nc">&nbsp;            throw IllegalStateException(&quot;Error creating post with images on Bluesky. Server responded with status ${response.status}: ${response.bodyAsText()}&quot;)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun convertDateToIso8601(date: Date): String {
<b class="nc">&nbsp;        return date.toInstant().toString()</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun parseFacets(text: String): List&lt;BlueskyFacet&gt; {
<b class="nc">&nbsp;        val mentions = parseMentions(text)</b>
<b class="nc">&nbsp;        val urls = parseUrls(text)</b>
<b class="nc">&nbsp;        val hashtags = parseHashtags(text)</b>
&nbsp;
<b class="nc">&nbsp;        val facets = mutableListOf&lt;BlueskyFacet&gt;()</b>
&nbsp;
<b class="nc">&nbsp;        mentions.forEach {</b>
<b class="nc">&nbsp;            val response = client.get(&quot;https://bsky.social/xrpc/com.atproto.identity.resolveHandle&quot;) {</b>
<b class="nc">&nbsp;                parameter(&quot;handle&quot;, it.handle)</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            if (response.status == HttpStatusCode.OK) {</b>
<b class="nc">&nbsp;                val did: BlueskyHandleResolve = response.body()</b>
<b class="nc">&nbsp;                facets.add(</b>
<b class="nc">&nbsp;                    BlueskyFacet(</b>
<b class="nc">&nbsp;                        index = BlueskyFacetIndex(it.start, it.end),</b>
<b class="nc">&nbsp;                        features = listOf(</b>
<b class="nc">&nbsp;                            BlueskyFacetFeature(</b>
<b class="nc">&nbsp;                                `$type` = &quot;app.bsky.richtext.facet#mention&quot;,</b>
<b class="nc">&nbsp;                                did = did.did</b>
&nbsp;                            )
&nbsp;                        )
&nbsp;                    )
&nbsp;                )
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        urls.forEach {</b>
<b class="nc">&nbsp;            facets.add(</b>
<b class="nc">&nbsp;                BlueskyFacet(</b>
<b class="nc">&nbsp;                    index = BlueskyFacetIndex(it.start, it.end),</b>
<b class="nc">&nbsp;                    features = listOf(BlueskyFacetFeature(`$type` = &quot;app.bsky.richtext.facet#link&quot;, uri = it.url))</b>
&nbsp;                )
&nbsp;            )
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        hashtags.forEach {</b>
<b class="nc">&nbsp;            facets.add(</b>
<b class="nc">&nbsp;                BlueskyFacet(</b>
<b class="nc">&nbsp;                    index = BlueskyFacetIndex(it.start, it.end),</b>
<b class="nc">&nbsp;                    features = listOf(BlueskyFacetFeature(`$type` = &quot;app.bsky.richtext.facet#tag&quot;, tag = it.hashtag))</b>
&nbsp;                )
&nbsp;            )
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        return facets</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun parseMentions(text: String): List&lt;MentionSpan&gt; {
<b class="nc">&nbsp;        val spans = mutableListOf&lt;MentionSpan&gt;()</b>
&nbsp;
&nbsp;        // Regex based on AT Protocol handle syntax
<b class="nc">&nbsp;        val mentionRegex =</b>
<b class="nc">&nbsp;            &quot;&quot;&quot;(?:\W|^)(@([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)&quot;&quot;&quot;.toRegex()</b>
&nbsp;
<b class="nc">&nbsp;        mentionRegex.findAll(text).forEach { matchResult -&gt;</b>
<b class="nc">&nbsp;            val handle = matchResult.groups[1]?.value?.substring(1) ?: return@forEach</b>
<b class="nc">&nbsp;            spans.add(MentionSpan(matchResult.range.first, matchResult.range.last + 1, handle))</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return spans</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun parseUrls(text: String): List&lt;UrlSpan&gt; {
<b class="nc">&nbsp;        val spans = mutableListOf&lt;UrlSpan&gt;()</b>
&nbsp;
&nbsp;        // Regex for detecting URLs
<b class="nc">&nbsp;        val urlRegex =</b>
<b class="nc">&nbsp;            &quot;&quot;&quot;(?:\W|^)(https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&amp;//=]*[-a-zA-Z0-9@%_+~#//=])?)&quot;&quot;&quot;.toRegex()</b>
&nbsp;
<b class="nc">&nbsp;        urlRegex.findAll(text).forEach { matchResult -&gt;</b>
<b class="nc">&nbsp;            val url = matchResult.groups[1]?.value ?: return@forEach</b>
<b class="nc">&nbsp;            spans.add(UrlSpan(matchResult.range.first, matchResult.range.last + 1, url))</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return spans</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun parseHashtags(text: String): List&lt;HashtagSpan&gt; {
<b class="nc">&nbsp;        val spans = mutableListOf&lt;HashtagSpan&gt;()</b>
&nbsp;
&nbsp;        // Regex for detecting hashtags
<b class="nc">&nbsp;        val hashtagRegex = &quot;&quot;&quot;(?:\W|^)(#[a-zA-Z0-9_]+)&quot;&quot;&quot;.toRegex()</b>
&nbsp;
<b class="nc">&nbsp;        hashtagRegex.findAll(text).forEach { matchResult -&gt;</b>
<b class="nc">&nbsp;            val hashtag = matchResult.groups[1]?.value ?: return@forEach</b>
<b class="nc">&nbsp;            spans.add(HashtagSpan(matchResult.range.first, matchResult.range.last + 1, hashtag))</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return spans</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-05-29 13:25</div>
</div>
</body>
</html>
