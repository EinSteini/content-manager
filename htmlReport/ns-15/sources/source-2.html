


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ThreadsPlatform</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">de.busesteinkamp.plugins.platform</a>
</div>

<h1>Coverage Summary for Class: ThreadsPlatform (de.busesteinkamp.plugins.platform)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ThreadsPlatform</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/98)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ThreadsPlatform$authorize$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$exchangeCodeForShortLivedToken$1</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$exchangeShortLivedTokenForLongLivedToken$1</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$handleNewMedia$1</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$LongLivedAccessTokenResponse</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$LongLivedAccessTokenResponse$Companion</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$MediaContainerResponse</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$MediaContainerResponse$Companion</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$receiveAuthKey$1</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$refreshAccessToken$1</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$ShortLivedAccessTokenResponse</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$ShortLivedAccessTokenResponse$Companion</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$testKeyAndReauthorize$1</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$upload$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$upload$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$uploadText$1</td>
  </tr>
  <tr>
    <td class="name">ThreadsPlatform$WhenMappings</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/114)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package de.busesteinkamp.plugins.platform
&nbsp;
&nbsp;import de.busesteinkamp.application.process.OpenUrlUseCase
&nbsp;import de.busesteinkamp.domain.auth.AuthKey
&nbsp;import de.busesteinkamp.domain.auth.AuthKeyRepository
&nbsp;import de.busesteinkamp.domain.auth.EnvRetriever
&nbsp;import de.busesteinkamp.domain.content.Content
&nbsp;import de.busesteinkamp.domain.content.ContentType
&nbsp;import de.busesteinkamp.domain.platform.SocialMediaPlatform
&nbsp;import de.busesteinkamp.domain.platform.PublishParameters
&nbsp;import de.busesteinkamp.domain.server.Server
&nbsp;import de.busesteinkamp.adapters.content.TextContent
&nbsp;import de.busesteinkamp.domain.process.UploadStatus
&nbsp;import de.busesteinkamp.plugins.server.ThreadsServerPlugin
&nbsp;import io.ktor.client.*
&nbsp;import io.ktor.client.call.*
&nbsp;import io.ktor.client.engine.cio.*
&nbsp;import io.ktor.client.plugins.contentnegotiation.*
&nbsp;import io.ktor.client.request.*
&nbsp;import io.ktor.client.request.forms.*
&nbsp;import io.ktor.http.*
&nbsp;import io.ktor.serialization.kotlinx.json.*
&nbsp;import kotlinx.coroutines.*
&nbsp;import kotlinx.serialization.Serializable
&nbsp;import kotlinx.serialization.json.Json
&nbsp;import java.util.*
&nbsp;
<b class="nc">&nbsp;class ThreadsPlatform(id: UUID?, name: String, private val server: Server, private val authKeyRepository: AuthKeyRepository, private val openUrlUseCase: OpenUrlUseCase, private val envRetriever: EnvRetriever) : SocialMediaPlatform(id, name) {</b>
&nbsp;
&nbsp;    private var authorized = false
&nbsp;
<b class="nc">&nbsp;    private val client: HttpClient = HttpClient(CIO){</b>
<b class="nc">&nbsp;        install(ContentNegotiation) {</b>
<b class="nc">&nbsp;            json(Json {</b>
<b class="nc">&nbsp;                ignoreUnknownKeys = true</b>
<b class="nc">&nbsp;                isLenient = true</b>
&nbsp;            })
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private val authPath = &quot;/auth&quot;</b>
<b class="nc">&nbsp;    private val authAddress = server.getAddress() + authPath</b>
&nbsp;
<b class="nc">&nbsp;    private val threadsServerPlugin = ThreadsServerPlugin(this, authPath)</b>
&nbsp;
&nbsp;    private val clientId: String
&nbsp;    private val clientSecret: String
&nbsp;
&nbsp;    private lateinit var apiKey: String
&nbsp;
<b class="nc">&nbsp;    private val mediaQueue: Queue&lt;Pair&lt;Content, PublishParameters&gt;&gt; = LinkedList()</b>
&nbsp;
&nbsp;    private var uploadInProgress = false
&nbsp;
<b class="nc">&nbsp;    init {</b>
<b class="nc">&nbsp;        clientId = envRetriever.getEnvVariable(&quot;THREADS_APP_CLIENT_ID&quot;)</b>
<b class="nc">&nbsp;        clientSecret = envRetriever.getEnvVariable(&quot;THREADS_APP_CLIENT_SECRET&quot;)</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
<b class="nc">&nbsp;    @Serializable</b>
<b class="nc">&nbsp;    private data class MediaContainerResponse(val id: String)</b>
&nbsp;
<b class="nc">&nbsp;    @Serializable</b>
<b class="nc">&nbsp;    data class LongLivedAccessTokenResponse(val access_token: String, val token_type: String, val expires_in: Int)</b>
&nbsp;
<b class="nc">&nbsp;    @Serializable</b>
<b class="nc">&nbsp;    data class ShortLivedAccessTokenResponse(val access_token: String, val user_id: String)</b>
&nbsp;
&nbsp;    override fun upload(content: Content, publishParameters: PublishParameters, callback: ((UploadStatus) -&gt; Unit)?) {
<b class="nc">&nbsp;        mediaQueue.add(Pair(content, publishParameters))</b>
<b class="nc">&nbsp;        CoroutineScope(Dispatchers.IO).launch {</b>
<b class="nc">&nbsp;            testKeyAndReauthorize(key = authKeyRepository.find(name), callback = suspend {</b>
<b class="nc">&nbsp;                callback?.invoke(UploadStatus.PENDING)</b>
<b class="nc">&nbsp;                handleNewMedia()</b>
&nbsp;            })
<b class="nc">&nbsp;            callback?.invoke(UploadStatus.FINISHED)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun handleNewMedia(){
<b class="nc">&nbsp;        if(uploadInProgress){</b>
&nbsp;            return
&nbsp;        }
<b class="nc">&nbsp;        if(mediaQueue.isEmpty()) {</b>
<b class="nc">&nbsp;            println(&quot;No media to upload&quot;)</b>
&nbsp;            return
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        uploadInProgress = true</b>
<b class="nc">&nbsp;        while(mediaQueue.isNotEmpty()){</b>
<b class="nc">&nbsp;            val (content, publishParameters) = mediaQueue.poll()</b>
<b class="nc">&nbsp;            when(content.contentType){</b>
<b class="nc">&nbsp;                ContentType.TEXT_PLAIN -&gt; uploadText(content)</b>
<b class="nc">&nbsp;                else -&gt; throw IllegalArgumentException(&quot;Unsupported media type&quot;)</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        uploadInProgress = false</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun uploadText(content: Content){
<b class="nc">&nbsp;        println(&quot;Uploading text file to Threads&quot;)</b>
<b class="nc">&nbsp;        val textFile = content as TextContent</b>
&nbsp;
<b class="nc">&nbsp;        var response = client.post(&quot;https://graph.threads.net/v1.0/me/threads&quot;){</b>
<b class="nc">&nbsp;            parameter(&quot;media_type&quot;, &quot;TEXT&quot;)</b>
<b class="nc">&nbsp;            parameter(&quot;text&quot;, textFile.get())</b>
<b class="nc">&nbsp;            parameter(&quot;access_token&quot;, apiKey)</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if(response.status != HttpStatusCode.OK){</b>
<b class="nc">&nbsp;            throw IllegalStateException(&quot;Error uploading text file to Threads. Server responded with status ${response.status}&quot;)</b>
&nbsp;        }
<b class="nc">&nbsp;        val mediaContainerResponse: MediaContainerResponse = response.body()</b>
&nbsp;
<b class="nc">&nbsp;        println(&quot;Uploaded text file to Threads. Media container ID: ${mediaContainerResponse.id}&quot;)</b>
&nbsp;
&nbsp;        // delay for 30 seconds to give Threads time to process the media
&nbsp;        // (documentation says it can take up to 30 seconds)
<b class="nc">&nbsp;        delay(30 * 1000)</b>
&nbsp;
<b class="nc">&nbsp;        response = client.post(&quot;https://graph.threads.net/v1.0/me/threads_publish&quot;){</b>
<b class="nc">&nbsp;            parameter(&quot;creation_id&quot;, mediaContainerResponse.id)</b>
<b class="nc">&nbsp;            parameter(&quot;access_token&quot;, apiKey)</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if(response.status != HttpStatusCode.OK){</b>
<b class="nc">&nbsp;            throw IllegalStateException(&quot;Error publishing text file to Threads. Server responded with status ${response.status}&quot;)</b>
&nbsp;        }
<b class="nc">&nbsp;        println(&quot;Published text file to Threads&quot;)</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun testKeyAndReauthorize(key: AuthKey?, callback: suspend () -&gt; Unit){
<b class="nc">&nbsp;        if(key != null){</b>
&nbsp;            // todo: check if key is working
<b class="nc">&nbsp;            if(key.expiresAt &lt; Date()){</b>
<b class="nc">&nbsp;                authKeyRepository.delete(name)</b>
<b class="nc">&nbsp;                authorize()</b>
&nbsp;                return
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            authorize()</b>
&nbsp;            return
&nbsp;        }
&nbsp;
&nbsp;        // If key is older than 24 hours, refresh it
<b class="nc">&nbsp;        if(key.createdAt.time &lt; Date().time - 1000 * 60 * 60 * 24){</b>
<b class="nc">&nbsp;            val refreshedKey = refreshAccessToken(key.key)</b>
<b class="nc">&nbsp;            authKeyRepository.update(refreshedKey)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        this.apiKey = key.key</b>
<b class="nc">&nbsp;        this.authorized = true</b>
<b class="nc">&nbsp;        callback()</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun authorize(){
<b class="nc">&nbsp;        this.authorized = false</b>
<b class="nc">&nbsp;        server.registerPlugin(threadsServerPlugin)</b>
<b class="nc">&nbsp;        if(!server.isRunning()){</b>
<b class="nc">&nbsp;            server.start()</b>
&nbsp;        }
<b class="nc">&nbsp;        withContext(Dispatchers.IO) {</b>
<b class="nc">&nbsp;            openUrlUseCase.execute(</b>
&nbsp;                    &quot;https://threads.net/oauth/authorize&quot; +
<b class="nc">&nbsp;                            &quot;?client_id=$clientId&quot; +</b>
<b class="nc">&nbsp;                            &quot;&amp;redirect_uri=$authAddress&quot; +</b>
&nbsp;                            &quot;&amp;scope=threads_basic,threads_content_publish&quot; +
&nbsp;                            &quot;&amp;response_type=code&quot;
&nbsp;                )
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    suspend fun receiveAuthKey(key: String) {
<b class="nc">&nbsp;        println(&quot;Received auth key: $key&quot;) // Totally safe and data compliant</b>
&nbsp;
<b class="nc">&nbsp;        val shortLivedToken = exchangeCodeForShortLivedToken(key)</b>
<b class="nc">&nbsp;        val longLivedToken = exchangeShortLivedTokenForLongLivedToken(shortLivedToken)</b>
&nbsp;
<b class="nc">&nbsp;        authKeyRepository.save(longLivedToken)</b>
<b class="nc">&nbsp;        this.apiKey = longLivedToken.key</b>
<b class="nc">&nbsp;        this.authorized = true</b>
<b class="nc">&nbsp;        handleNewMedia()</b>
<b class="nc">&nbsp;        server.unregisterPlugin(threadsServerPlugin)</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun exchangeCodeForShortLivedToken(code: String): String {
<b class="nc">&nbsp;        val response = client.post(&quot;https://graph.threads.net/oauth/access_token&quot;) {</b>
<b class="nc">&nbsp;            setBody(FormDataContent(Parameters.build {</b>
<b class="nc">&nbsp;                append(&quot;client_id&quot;, clientId)</b>
<b class="nc">&nbsp;                append(&quot;client_secret&quot;, clientSecret)</b>
<b class="nc">&nbsp;                append(&quot;code&quot;, code)</b>
<b class="nc">&nbsp;                append(&quot;grant_type&quot;, &quot;authorization_code&quot;)</b>
<b class="nc">&nbsp;                append(&quot;redirect_uri&quot;, &quot;https://0.0.0.0:8443/auth&quot;)</b>
<b class="nc">&nbsp;            }))</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        val accessTokenResponse: ShortLivedAccessTokenResponse = response.body()</b>
<b class="nc">&nbsp;        println(&quot;Received short lived access token: ${accessTokenResponse.access_token}&quot;)</b>
<b class="nc">&nbsp;        return accessTokenResponse.access_token</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun exchangeShortLivedTokenForLongLivedToken(token: String): AuthKey{
<b class="nc">&nbsp;        val response = client.get(&quot;https://graph.threads.net/access_token&quot;){</b>
<b class="nc">&nbsp;            parameter(&quot;client_secret&quot;, clientSecret)</b>
<b class="nc">&nbsp;            parameter(&quot;access_token&quot;, token)</b>
<b class="nc">&nbsp;            parameter(&quot;grant_type&quot;, &quot;th_exchange_token&quot;)</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;        val accessTokenResponse: LongLivedAccessTokenResponse = response.body()</b>
<b class="nc">&nbsp;        println(&quot;Received long lived access token: ${accessTokenResponse.access_token}&quot;)</b>
<b class="nc">&nbsp;        val authKey = AuthKey(name, accessTokenResponse.access_token, Date(), Date(Date().time + accessTokenResponse.expires_in * 1000))</b>
<b class="nc">&nbsp;        return authKey</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun refreshAccessToken(token: String): AuthKey{
<b class="nc">&nbsp;        val response = client.get(&quot;https://graph.threads.net/refresh_access_token&quot;){</b>
<b class="nc">&nbsp;            parameter(&quot;access_token&quot;, token)</b>
<b class="nc">&nbsp;            parameter(&quot;grant_type&quot;, &quot;th_refresh_token&quot;)</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        val accessTokenResponse: LongLivedAccessTokenResponse = response.body()</b>
<b class="nc">&nbsp;        println(&quot;Received long lived access token: ${accessTokenResponse.access_token}&quot;)</b>
<b class="nc">&nbsp;        val authKey = AuthKey(name, accessTokenResponse.access_token, Date(), Date(Date().time + accessTokenResponse.expires_in * 1000))</b>
<b class="nc">&nbsp;        return authKey</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-05-29 13:25</div>
</div>
</body>
</html>
